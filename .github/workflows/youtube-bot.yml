
name: YouTube Chat Bot - Auto Stream Detection

on:
  # Run every 10 minutes to check for live streams
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      video_id:
        description: 'YouTube Video ID (optional - will auto-detect if empty)'
        required: false
        type: string

concurrency:
  group: youtube-bot-run
  cancel-in-progress: false

jobs:
  check-and-run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours max
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if another run is already in progress
      run: |
        # Get all in-progress runs for this workflow
        RUNS=$(gh run list --repo=${{ github.repository }} --workflow=youtube-bot.yml --status=in_progress --json databaseId --jq 'length')
        
        # If there's more than 1 run in progress (current + others), skip
        if [ "$RUNS" -gt 1 ]; then
          echo "‚ùå Another bot run is already in progress. Skipping this scheduled run."
          exit 0
        fi
        
        echo "‚úÖ No other runs in progress. Proceeding..."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: app
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Restore OAuth token from cache
      id: cache-token
      uses: actions/cache@v4
      with:
        path: app/token.pickle
        key: youtube-oauth-token-${{ github.run_id }}
        restore-keys: |
          youtube-oauth-token-
    
    - name: Restore token from secrets
      if: steps.cache-token.outputs.cache-hit != 'true'
      run: |
        mkdir -p app
        echo "${{ secrets.YOUTUBE_TOKEN_BASE64 }}" | base64 -d > app/token.pickle
      continue-on-error: true
    
    - name: Restore client_secret.json
      run: |
        mkdir -p app
        echo "${{ secrets.CLIENT_SECRET_JSON }}" > app/client_secret.json
    
    - name: Restore streamer profile
      run: |
        mkdir -p app

        # Prefer base64 secrets/vars to avoid JSON escaping issues
        if [ -n "${{ secrets.STREAMER_PROFILE_JSON_B64 }}" ]; then
          echo "${{ secrets.STREAMER_PROFILE_JSON_B64 }}" | base64 -d > app/streamer_profile.json
        elif [ -n "${{ secrets.STREAMER_PROFILE_JSON }}" ]; then
          printf '%s' "${{ secrets.STREAMER_PROFILE_JSON }}" > app/streamer_profile.json
        elif [ -n "${{ vars.STREAMER_PROFILE_JSON_B64 }}" ]; then
          echo "${{ vars.STREAMER_PROFILE_JSON_B64 }}" | base64 -d > app/streamer_profile.json
        elif [ -n "${{ vars.STREAMER_PROFILE_JSON }}" ]; then
          printf '%s' "${{ vars.STREAMER_PROFILE_JSON }}" > app/streamer_profile.json
        else
          echo "No STREAMER_PROFILE_JSON provided (secret or var). Using defaults."
        fi
      continue-on-error: true
    
    - name: Create necessary directories
      run: |
        mkdir -p app/logs app/data
    
    - name: Check for live stream and run bot
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        HENRIK_DEV_API_KEY: ${{ secrets.HENRIK_DEV_API_KEY }}
        AGENT_NAME: youtube_chat_advanced
        YOUTUBE_VIDEO_ID: ${{ inputs.video_id }}
      run: |
        echo "üîç Checking for active live stream..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/app"
        python app/run_youtube_bot.py
        BOT_EXIT_CODE=$?
        if [ $BOT_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Bot completed successfully - stream ended"
          exit 0
        else
          echo "‚ùå Bot exited with error code: $BOT_EXIT_CODE"
          exit $BOT_EXIT_CODE
        fi
      timeout-minutes: 240
    
    - name: Save OAuth token to cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: app/token.pickle
        key: youtube-oauth-token-${{ github.run_id }}
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-logs-${{ github.run_number }}
        path: app/logs/
        retention-days: 7
