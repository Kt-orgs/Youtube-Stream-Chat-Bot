
name: YouTube Chat Bot - Auto Stream Detection

on:
  # Run every 10 minutes to check for live streams
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      video_id:
        description: 'YouTube Video ID (optional - will auto-detect if empty)'
        required: false
        type: string

concurrency:
  group: youtube-bot-run
  cancel-in-progress: false

jobs:
  check-and-run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours max
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if another run is already in progress
      run: |
        # Get all in-progress runs for this workflow
        RUNS=$(gh run list --repo=${{ github.repository }} --workflow=youtube-bot.yml --status=in_progress --json databaseId --jq 'length')
        
        # If there's more than 1 run in progress (current + others), skip
        if [ "$RUNS" -gt 1 ]; then
          echo "‚ùå Another bot run is already in progress. Skipping this scheduled run."
          exit 0
        fi
        
        echo "‚úÖ No other runs in progress. Proceeding..."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: app
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Restore OAuth token from cache
      id: cache-token
      uses: actions/cache@v4
      with:
        path: app/token.pickle
        key: youtube-oauth-token-${{ github.run_id }}
        restore-keys: |
          youtube-oauth-token-
    
    - name: Restore token from secrets
      if: steps.cache-token.outputs.cache-hit != 'true'
      run: |
        mkdir -p app
        echo "${{ secrets.YOUTUBE_TOKEN_BASE64 }}" | base64 -d > app/token.pickle
      continue-on-error: true
    
    - name: Restore client_secret.json
      run: |
        mkdir -p app
        echo "${{ secrets.CLIENT_SECRET_JSON }}" > app/client_secret.json
    
    - name: Restore streamer profile
      run: |
        mkdir -p app
        
        # Try different sources for profile (base64 preferred)
        PROFILE_B64_SECRET="${{ secrets.STREAMER_PROFILE_JSON_B64 }}"
        PROFILE_SECRET="${{ secrets.STREAMER_PROFILE_JSON }}"
        PROFILE_B64_VAR="${{ vars.STREAMER_PROFILE_JSON_B64 }}"
        PROFILE_VAR="${{ vars.STREAMER_PROFILE_JSON }}"
        
        if [ ! -z "$PROFILE_B64_SECRET" ]; then
          echo "$PROFILE_B64_SECRET" | base64 -d > app/streamer_profile.json
          echo "‚úÖ Restored profile from STREAMER_PROFILE_JSON_B64 secret"
        elif [ ! -z "$PROFILE_SECRET" ]; then
          printf '%s' "$PROFILE_SECRET" > app/streamer_profile.json
          echo "‚úÖ Restored profile from STREAMER_PROFILE_JSON secret"
        elif [ ! -z "$PROFILE_B64_VAR" ]; then
          echo "$PROFILE_B64_VAR" | base64 -d > app/streamer_profile.json
          echo "‚úÖ Restored profile from STREAMER_PROFILE_JSON_B64 variable"
        elif [ ! -z "$PROFILE_VAR" ]; then
          printf '%s' "$PROFILE_VAR" > app/streamer_profile.json
          echo "‚úÖ Restored profile from STREAMER_PROFILE_JSON variable"
        else
          echo "‚ö†Ô∏è No STREAMER_PROFILE_JSON provided. Will create from env vars."
        fi
      continue-on-error: true
    
    - name: Create necessary directories
      run: |
        mkdir -p app/logs app/data
    
    - name: Check for live stream and run bot
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        HENRIK_DEV_API_KEY: ${{ secrets.HENRIK_DEV_API_KEY }}
        AGENT_NAME: youtube_chat_advanced
        YOUTUBE_VIDEO_ID: ${{ inputs.video_id }}
        # Streamer profile env vars
        STREAMER_NAME: ${{ vars.STREAMER_NAME || 'Streamer' }}
        VALORANT_ID: ${{ vars.VALORANT_ID || secrets.VALORANT_ID }}
        VALORANT_REGION: ${{ vars.VALORANT_REGION || 'eu' }}
        # Socials (optional)
        TWITTER_HANDLE: ${{ vars.TWITTER_HANDLE || secrets.TWITTER_HANDLE }}
        INSTAGRAM_HANDLE: ${{ vars.INSTAGRAM_HANDLE || secrets.INSTAGRAM_HANDLE }}
        DISCORD_INVITE: ${{ vars.DISCORD_INVITE || secrets.DISCORD_INVITE }}
        TWITCH_URL: ${{ vars.TWITCH_URL || secrets.TWITCH_URL }}
      run: |
        echo "üîç Checking for active live stream..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/app"
        python app/run_youtube_bot.py
        BOT_EXIT_CODE=$?
        if [ $BOT_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Bot completed successfully - stream ended"
          exit 0
        else
          echo "‚ùå Bot exited with error code: $BOT_EXIT_CODE"
          exit $BOT_EXIT_CODE
        fi
      timeout-minutes: 240
    
    - name: Save OAuth token to cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: app/token.pickle
        key: youtube-oauth-token-${{ github.run_id }}
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-logs-${{ github.run_number }}
        path: app/logs/
        retention-days: 7
